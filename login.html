<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ColfApp Backup PocketBase</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/onsenui/css/onsenui.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/onsenui/css/onsen-css-components.min.css">
  <script src="https://cdn.jsdelivr.net/npm/onsenui/js/onsenui.min.js"></script>
</head>
<body>
  <ons-page>
    <ons-toolbar><div class="center">ColfApp PocketBase</div></ons-toolbar>

    <ons-card>
      <ons-input id="email" placeholder="Email" modifier="underbar"></ons-input>
      <ons-input id="password" placeholder="Password" type="password" modifier="underbar"></ons-input>
      <ons-button onclick="register()">Registrati</ons-button>
      <ons-button onclick="login()">Login</ons-button>
    </ons-card>

    <ons-card>
      <input type="file" id="fileInput">
      <ons-button onclick="manualBackup()">Carica Backup Ora</ons-button>
      <ons-button onclick="listFiles()">Mostra Backup</ons-button>
      <ul id="fileList"></ul>
    </ons-card>

  </ons-page>

<script type="module">
import PocketBase from "https://cdn.jsdelivr.net/npm/pocketbase@0.17.1/dist/pocketbase.es.mjs";

// PocketBase client
const pb = new PocketBase("http://127.0.0.1:8090");

// ===== IndexedDB helper =====
function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("ColfAppDB", 1);
    request.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains("state")) db.createObjectStore("state", { keyPath: "id" });
      if (!db.objectStoreNames.contains("queue")) db.createObjectStore("queue", { autoIncrement: true });
    };
    request.onsuccess = e => resolve(e.target.result);
    request.onerror = e => reject(e.target.error);
  });
}

async function saveState(state) {
  const db = await openDB();
  const tx = db.transaction("state", "readwrite");
  tx.objectStore("state").put({ id:"appState", data:state });
  return tx.complete;
}

async function loadState() {
  const db = await openDB();
  return new Promise(resolve => {
    const tx = db.transaction("state", "readonly");
    const req = tx.objectStore("state").get("appState");
    req.onsuccess = () => resolve(req.result?.data || {});
  });
}

async function addToQueue(blob) {
  const db = await openDB();
  const tx = db.transaction("queue","readwrite");
  tx.objectStore("queue").add(blob);
  return tx.complete;
}

async function getQueue() {
  const db = await openDB();
  return new Promise(resolve => {
    const tx = db.transaction("queue","readonly");
    const req = tx.objectStore("queue").getAll();
    req.onsuccess = () => resolve(req.result);
  });
}

async function clearQueue() {
  const db = await openDB();
  const tx = db.transaction("queue","readwrite");
  tx.objectStore("queue").clear();
  return tx.complete;
}

async function exportStateToBlob() {
  const state = await loadState();
  return new Blob([JSON.stringify(state)], { type:"application/json" });
}

// ===== Auth =====
window.register = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    await pb.collection("users").create({ email, password, passwordConfirm: password });
    alert("Registrazione effettuata!");
  } catch(e){ alert(e.message); }
};

window.login = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    await pb.collection("users").authWithPassword(email, password);
    alert("Login effettuato!");
  } catch(e){ alert(e.message); }
};

// ===== Backup =====
async function uploadBackup(blob) {
  if (!pb.authStore.isValid) return;
  try {
    const file = new File([blob], `backup-${Date.now()}.json`);
    await pb.collection("backups").create({
      user: pb.authStore.model.id
    }, { file: file });
    console.log("âœ… Backup caricato");
  } catch(e) {
    console.log("Errore upload, aggiungo alla coda", e);
    await addToQueue(blob);
  }
}

async function autoBackup() {
  const blob = await exportStateToBlob();
  if (navigator.onLine) {
    const queue = await getQueue();
    for (const qBlob of queue) await uploadBackup(qBlob);
    await clearQueue();
    await uploadBackup(blob);
  } else {
    console.log("Offline, backup in coda");
    await addToQueue(blob);
  }
}

window.manualBackup = autoBackup;
window.addEventListener("online", autoBackup);

// ===== Lista backup =====
window.listFiles = async () => {
  if (!pb.authStore.isValid) return;
  const records = await pb.collection("backups").getFullList(200, { filter: `user="${pb.authStore.model.id}"` });
  const container = document.getElementById("fileList");
  container.innerHTML = "";
  for (const rec of records) {
    const li = document.createElement("li");
    li.innerHTML = `<a href="${pb.getFileUrl(rec, "file")}" target="_blank">${rec.file}</a>`;
    container.appendChild(li);
  }
};
</script>
</body>
</html>
